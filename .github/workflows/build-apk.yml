name: Build APK

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:
  release:
    types: [created]

jobs:
  build-apk:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
    
    - name: Setup Java
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '17'
    
    - name: Setup Android SDK
      uses: android-actions/setup-android@v3
    
    - name: Install PWA Builder CLI
      run: npm install -g @pwabuilder/cli
    
    - name: Generate APK from URL
      env:
        PWA_URL: ${{ secrets.PWA_URL || 'https://mega.mrit.com.br' }}
      run: |
        echo "üîó Gerando APK a partir da URL: $PWA_URL"
        echo "üìã Verificando URL antes de gerar..."
        curl -I "$PWA_URL" || echo "‚ö†Ô∏è N√£o foi poss√≠vel acessar a URL"
        curl -I "$PWA_URL/manifest.json" || echo "‚ö†Ô∏è Manifest n√£o encontrado"
        
        # Tentar m√©todo com Bubblewrap (mais confi√°vel)
        echo "üîÑ Instalando Bubblewrap CLI..."
        npm install -g @bubblewrap/cli || echo "‚ö†Ô∏è Falha ao instalar Bubblewrap"
        
        # Criar diret√≥rio no workspace
        mkdir -p ./bubblewrap-build
        cd ./bubblewrap-build
        
        echo "üì¶ Inicializando projeto TWA..."
        # Inicializar TWA de forma n√£o-interativa
        echo -e "n\n" | bubblewrap init \
          --manifest "$PWA_URL/manifest.json" \
          --package-id com.mritsoftware.player \
          --app-version-name "1.0.0" \
          --app-version-code 1 \
          --app-name "MRIT Player" \
          --app-short-name "MRIT" \
          --display-mode standalone \
          --theme-color "#000000" \
          --background-color "#000000" \
          --orientation any \
          --default-icon "$PWA_URL/icon-512.png" \
          --maskable-icon "$PWA_URL/icon-512.png" \
          --skipPwaValidation \
          --yes || {
            echo "‚ö†Ô∏è Bubblewrap init falhou, tentando m√©todo alternativo..."
            cd ..
            
            # M√©todo alternativo: usar PWA Builder
            echo "üîÑ Tentando PWA Builder..."
            pwabuilder android \
              --url "$PWA_URL" \
              --package com.mritsoftware.player \
              --name "MRIT Player" \
              --short-name "MRIT" \
              --display standalone \
              --orientation any \
              --theme-color "#000000" \
              --background-color "#000000" \
              --skipPwaValidation || echo "‚ö†Ô∏è PWA Builder tamb√©m falhou"
            exit 0
          }
        
        # Se chegou aqui, Bubblewrap init funcionou
        echo "‚úÖ Projeto TWA inicializado"
        
        # Encontrar diret√≥rio do projeto
        TWA_DIR=""
        if [ -d "twa-manifest" ]; then
          TWA_DIR="twa-manifest"
        elif [ -d ".twa-manifest" ]; then
          TWA_DIR=".twa-manifest"
        else
          echo "‚ö†Ô∏è Diret√≥rio TWA n√£o encontrado"
          cd ..
          exit 0
        fi
        
        cd "$TWA_DIR"
        echo "üìÅ Diret√≥rio TWA: $(pwd)"
        
        # Build APK
        echo "üî® Construindo APK..."
        bubblewrap build --skipPwaValidation || {
          echo "‚ö†Ô∏è Build falhou, tentando com gradlew diretamente..."
          if [ -f "gradlew" ]; then
            chmod +x gradlew
            ./gradlew assembleRelease || ./gradlew assembleDebug
          fi
        }
        
        # Voltar para workspace root
        cd ../../..
        echo "‚úÖ Processo de build conclu√≠do"
    
    - name: Find and Copy APK files
      run: |
        echo "üîç Procurando arquivos APK em todo o workspace..."
        echo "üìÅ Estrutura de diret√≥rios:"
        find . -type d -name "*android*" -o -name "*bubblewrap*" -o -name "*twa*" -o -name "*pwabuilder*" 2>/dev/null | head -20
        
        echo ""
        echo "üì¶ Procurando APKs..."
        find . -name "*.apk" -type f 2>/dev/null | while read apk; do
          echo "‚úÖ Encontrado: $apk ($(du -h "$apk" | cut -f1))"
        done
        
        echo ""
        echo "üìã Verificando locais espec√≠ficos:"
        
        # Criar diret√≥rio de sa√≠da
        mkdir -p ./apk-output
        
        # Procurar em todos os locais poss√≠veis
        APK_COUNT=0
        
        # Bubblewrap build
        if [ -d "bubblewrap-build" ]; then
          echo "üìÅ Verificando bubblewrap-build..."
          find bubblewrap-build -name "*.apk" -type f | while read apk; do
            echo "  ‚Üí Copiando: $apk"
            cp "$apk" "./apk-output/" && APK_COUNT=$((APK_COUNT + 1))
          done
        fi
        
        # Android padr√£o
        if [ -d "android" ]; then
          echo "üìÅ Verificando android..."
          find android -name "*.apk" -type f | while read apk; do
            echo "  ‚Üí Copiando: $apk"
            cp "$apk" "./apk-output/" && APK_COUNT=$((APK_COUNT + 1))
          done
        fi
        
        # PWA Builder
        if [ -d ".pwabuilder" ]; then
          echo "üìÅ Verificando .pwabuilder..."
          find .pwabuilder -name "*.apk" -type f | while read apk; do
            echo "  ‚Üí Copiando: $apk"
            cp "$apk" "./apk-output/" && APK_COUNT=$((APK_COUNT + 1))
          done
        fi
        
        # Qualquer APK na raiz ou subdiret√≥rios
        find . -maxdepth 3 -name "*.apk" -type f ! -path "./apk-output/*" | while read apk; do
          echo "  ‚Üí Copiando: $apk"
          cp "$apk" "./apk-output/" && APK_COUNT=$((APK_COUNT + 1))
        done
        
        echo ""
        echo "üìä Resumo:"
        if [ -d "./apk-output" ] && [ "$(ls -A ./apk-output 2>/dev/null)" ]; then
          echo "‚úÖ APKs encontrados e copiados:"
          ls -lh ./apk-output/
        else
          echo "‚ö†Ô∏è Nenhum APK foi encontrado ou copiado"
          echo "üìã Listando todo o conte√∫do do workspace:"
          find . -type f -name "*.gradle" -o -name "*.xml" -o -name "*.json" | head -10
        fi
    
    - name: Upload APK artifact
      uses: actions/upload-artifact@v4
      with:
        name: mrit-player-apk
        path: |
          apk-output/*.apk
        if-no-files-found: warn
        retention-days: 30
    
    - name: Create Release
      if: github.event_name == 'release'
      uses: softprops/action-gh-release@v1
      with:
        files: |
          **/*.apk
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
