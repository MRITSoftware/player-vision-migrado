name: Build APK - Vision Player

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch: # Permite executar manualmente

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout c√≥digo
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        
    - name: Instalar depend√™ncias
      run: npm install
      
    - name: Build do projeto
      run: npm run build
      
    - name: Setup Java
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '17'
        
    - name: Setup Android SDK
      uses: android-actions/setup-android@v3
      with:
        packages: platform-tools platforms;android-33 build-tools;33.0.0
        accept-android-sdk-licenses: true
        
    - name: Instalar Capacitor CLI
      run: npm install -g @capacitor/cli
      
    - name: Adicionar plataforma Android (se necess√°rio)
      run: |
        if [ ! -d "android" ]; then
          echo "üìÅ Pasta android n√£o existe, executando npx cap add android..."
          npx cap add android
        else
          echo "‚úÖ Pasta android j√° existe, pulando npx cap add android"
        fi
      
    - name: Sincronizar Capacitor
      run: npx cap sync android
      
    - name: Copiar MainActivity.java para o projeto Android
      run: |
        mkdir -p android/app/src/main/java/com/mritsoftware/player
        cp MainActivity.java android/app/src/main/java/com/mritsoftware/player/MainActivity.java
        echo "‚úÖ MainActivity.java copiado"
      
    - name: Configurar permiss√µes do Gradle
      run: chmod +x android/gradlew
      
    - name: Build APK Debug
      working-directory: android
      run: ./gradlew assembleDebug --no-daemon
      env:
        ANDROID_HOME: ${{ env.ANDROID_HOME }}
        ANDROID_SDK_ROOT: ${{ env.ANDROID_SDK_ROOT }}
        JAVA_HOME: ${{ env.JAVA_HOME }}
        
    - name: Upload APK como artefato
      uses: actions/upload-artifact@v4
      with:
        name: vision-player-apk
        path: android/app/build/outputs/apk/debug/app-debug.apk
        retention-days: 30
        
    - name: Upload APK para Release (se for tag)
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      with:
        files: android/app/build/outputs/apk/debug/app-debug.apk
        body: |
          ## üì± Vision Player APK
          
          APK gerado automaticamente via GitHub Actions.
          
          **Vers√£o:** ${{ github.ref_name }}
          **Commit:** ${{ github.sha }}
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
