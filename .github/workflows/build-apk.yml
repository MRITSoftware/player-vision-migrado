name: Build APK

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:
  release:
    types: [created]

jobs:
  build-apk:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
    
    - name: Setup Java
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '17'
    
    - name: Setup Android SDK
      uses: android-actions/setup-android@v3
    
    - name: Install PWA Builder CLI
      run: npm install -g @pwabuilder/cli
    
    - name: Generate APK from URL
      env:
        PWA_URL: ${{ secrets.PWA_URL || 'https://mega.mrit.com.br' }}
      run: |
        echo "üîó Gerando APK a partir da URL: $PWA_URL"
        
        # Gerar APK usando PWA Builder com URL
        pwabuilder android \
          --url "$PWA_URL" \
          --package com.mritsoftware.player \
          --name "MRIT Player" \
          --short-name "MRIT" \
          --display standalone \
          --orientation any \
          --theme-color "#000000" \
          --background-color "#000000" \
          --skipPwaValidation || echo "‚ö†Ô∏è PWA Builder pode ter falhado, tentando m√©todo alternativo..."
        
        # Se falhar, tentar m√©todo alternativo com Bubblewrap
        if [ ! -f "*.apk" ] && [ ! -d "android" ]; then
          echo "üîÑ Tentando m√©todo alternativo com Bubblewrap..."
          npm install -g @bubblewrap/cli || true
          
          # Criar diret√≥rio no workspace (n√£o usar /tmp)
          mkdir -p ./bubblewrap-build
          cd ./bubblewrap-build
          
          # Inicializar TWA
          echo "n" | bubblewrap init \
            --manifest "$PWA_URL/manifest.json" \
            --package-id com.mritsoftware.player \
            --app-version-name "1.0.0" \
            --app-version-code 1 \
            --app-name "MRIT Player" \
            --app-short-name "MRIT" \
            --display-mode standalone \
            --theme-color "#000000" \
            --background-color "#000000" \
            --orientation any \
            --default-icon "$PWA_URL/icon-512.png" \
            --maskable-icon "$PWA_URL/icon-512.png" \
            --skipPwaValidation || true
          
          # Build APK
          if [ -d "twa-manifest" ] || [ -d ".twa-manifest" ]; then
            cd twa-manifest || cd .twa-manifest
            bubblewrap build --skipPwaValidation || true
            # Voltar para workspace root
            cd ../../..
          fi
        fi
    
    - name: Find APK files
      run: |
        echo "üîç Procurando arquivos APK..."
        find . -name "*.apk" -type f 2>/dev/null | head -20 || echo "Nenhum APK encontrado em ."
        echo "üìÅ Verificando diret√≥rios espec√≠ficos..."
        ls -la android/app/build/outputs/apk/ 2>/dev/null || echo "Diret√≥rio android n√£o encontrado"
        ls -la .pwabuilder/ 2>/dev/null || echo "Diret√≥rio .pwabuilder n√£o encontrado"
    
    - name: Copy APK to workspace root
      run: |
        echo "üì¶ Copiando APKs para raiz do workspace..."
        mkdir -p ./apk-output
        
        # Procurar APKs em locais espec√≠ficos
        if [ -d "android/app/build/outputs/apk" ]; then
          find android/app/build/outputs/apk -name "*.apk" -type f -exec cp {} ./apk-output/ \; 2>/dev/null || true
        fi
        
        if [ -d ".pwabuilder" ]; then
          find .pwabuilder -name "*.apk" -type f -exec cp {} ./apk-output/ \; 2>/dev/null || true
        fi
        
        if [ -d "bubblewrap-build" ]; then
          find bubblewrap-build -name "*.apk" -type f -exec cp {} ./apk-output/ \; 2>/dev/null || true
        fi
        
        # Procurar APKs na raiz
        find . -maxdepth 1 -name "*.apk" -type f -exec cp {} ./apk-output/ \; 2>/dev/null || true
        
        echo "üìã APKs encontrados:"
        ls -lh ./apk-output/ 2>/dev/null || echo "‚ö†Ô∏è Nenhum APK encontrado"
    
    - name: Upload APK artifact
      uses: actions/upload-artifact@v4
      with:
        name: mrit-player-apk
        path: |
          apk-output/*.apk
        if-no-files-found: warn
        retention-days: 30
    
    - name: Create Release
      if: github.event_name == 'release'
      uses: softprops/action-gh-release@v1
      with:
        files: |
          **/*.apk
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
