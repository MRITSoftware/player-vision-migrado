<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <!-- cobre √°reas seguras (iOS) e melhora c√°lculo da viewport -->
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, user-scalable=no" />
  <!-- Esconder barra de URL no Android Chrome -->
  <meta name="mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="theme-color" content="#000000" />
  <link rel="manifest" href="manifest.json" />
  <title>MRIT Player</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; font-family: Arial, sans-serif; }

    html, body {
      width: 100%;
      height: 100%;
      background-color: #000;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      overflow: hidden;
      color: #fff;
    }

    /* Logo fixo no topo */
    #logo {
      position: fixed;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      max-width: 240px;
      width: 100%;
      height: auto;
      animation: fadeIn 1s ease;
      z-index: 3;
    }

    /* Rodap√© */
    footer {
      position: fixed;
      bottom: 10px;
      width: 100%;
      text-align: center;
      font-size: 14px;
      color: rgba(255, 255, 255, 0.7);
      font-weight: 300;
      letter-spacing: 1px;
      user-select: none;
      transition: opacity 0.5s ease;
      z-index: 3;
    }
    footer.fade-out { opacity: 0; }
    
    /* Link do rodap√© */
    footer a {
      color: inherit;
      text-decoration: none;
      transition: color 0.3s ease;
    }
    footer a:hover {
      color: rgba(255, 255, 255, 1);
      text-decoration: underline;
    }

    @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
    @keyframes fadeOut { from { opacity: 1; transform: translateY(0); } to { opacity: 0; transform: translateY(-20px); } }

    /* Painel de Debug Visual */
    #debugPanel {
      position: fixed;
      bottom: 10px;
      left: 10px;
      right: 10px;
      max-height: 200px;
      background: rgba(0, 0, 0, 0.9);
      color: #0f0;
      font-family: 'Courier New', monospace;
      font-size: 11px;
      padding: 10px;
      border: 2px solid #0f0;
      border-radius: 5px;
      overflow-y: auto;
      z-index: 10000;
      display: none;
    }
    #debugPanel.show { display: block; }
    #debugPanel .log { margin: 2px 0; }
    #debugPanel .error { color: #f00; }
    #debugPanel .warn { color: #ff0; }
    #debugPanel .info { color: #0ff; }
    #debugToggle {
      position: fixed;
      bottom: 10px;
      right: 10px;
      width: 50px;
      height: 50px;
      background: rgba(0, 255, 0, 0.3);
      border: 2px solid #0f0;
      border-radius: 50%;
      color: #0f0;
      font-size: 20px;
      cursor: pointer;
      z-index: 10001;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    #codigoInput {
      display: flex; flex-direction: column; align-items: center; text-align: center;
      gap: 20px; padding: 40px; border-radius: 12px;
      background: rgba(0, 0, 0, 0.7); backdrop-filter: blur(6px);
      width: 90%; max-width: 320px; animation: fadeIn 0.8s ease forwards;
      margin-top: 120px; /* espa√ßo para o logo */
      z-index: 3;
    }
    #codigoInput.fade-out { animation: fadeOut 0.6s ease forwards; }

    #codigoTela {
      padding: 14px; font-size: 1.2rem; width: 100%; max-width: 300px;
      border: none; border-radius: 8px; outline: none; text-align: center;
      background-color: #fff;
      color: #000;
    }
    #codigoInput button {
      padding: 14px 24px; font-size: 1.2rem; background: #007bff; color: #fff;
      border: none; border-radius: 8px; cursor: pointer; transition: 0.3s;
      width: 100%; max-width: 300px;
    }
    #codigoInput button:hover { background: #0056b3; }

    @media (max-width: 768px) {
      #codigoInput { padding: 30px; gap: 16px; }
      #codigoTela, #codigoInput button { font-size: 1rem; }
      footer { font-size: 12px; }
    }

    /* M√≠dia ocupa 100% da viewport (sem ‚Äúfilete‚Äù nas bordas).
       O JS altera object-fit para cover/contain conforme regras e orienta√ß√£o. */
    video, img {
      position: fixed;
      inset: -1px; /* bleed 1px */
      width: calc(100dvw + 2px);
      height: calc(100dvh + 2px);
      width: calc(100vw + 2px);   /* fallback */
      height: calc(100vh + 2px);  /* fallback */

      object-fit: cover;            /* <<< full screen (aceita corte) */
      object-position: center center;
      background: #000;
      border: 0;
      outline: none;
      display: block;
      backface-visibility: hidden;
      transform: translateZ(0);
      z-index: 1;
    }

    /* Respeita rota√ß√£o EXIF de fotos verticais */
    img { image-orientation: from-image; }
  </style>
</head>
<body>
  <!-- Logo fixo -->
  <img id="logo" src="vision_logo.png" alt="Logo Vision" />

  <!-- √Årea de login -->
  <div id="codigoInput">
    <input
      type="text"
      id="codigoTela"
      placeholder="C√≥digo do display"
      style="text-transform: uppercase;"
      oninput="this.value = this.value.toUpperCase()"
    />
    <button id="btnEntrar">Iniciar</button>
  </div>

  <video id="videoPlayer" autoplay muted playsinline style="display:none"></video>
  <img id="imgPlayer" style="display:none" />

  <!-- Rodap√© -->
  <footer id="rodape"><a href="https://www.mrit.com.br" target="_blank" style="color: inherit; text-decoration: none;">¬© 2025 MRIT</a></footer>

  <!-- Painel de Debug Visual -->
  <div id="debugPanel"></div>
  <button id="debugToggle" title="Mostrar/Ocultar Debug">üîç</button>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
  <!-- hls.js para buffer via MSE (apenas quando URL for .m3u8) -->
  <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
  <!-- Capacitor para funcionalidades nativas (APK) -->
  <script type="module" src="/capacitor-setup.js"></script>
  <script src="player.js"></script>

  <script>
    // Sistema de Debug Visual
    const debugPanel = document.getElementById('debugPanel');
    const debugToggle = document.getElementById('debugToggle');
    let debugLogs = [];
    const MAX_LOGS = 50;

    function addDebugLog(message, type = 'info') {
      try {
        const timestamp = new Date().toLocaleTimeString();
        const logEntry = { time: timestamp, message, type };
        debugLogs.push(logEntry);
        
        // Limitar quantidade de logs
        if (debugLogs.length > MAX_LOGS) {
          debugLogs.shift();
        }
        
        // Atualizar painel se estiver vis√≠vel
        if (debugPanel && debugPanel.classList.contains('show')) {
          updateDebugPanel();
        }
      } catch (e) {
        // Ignorar erros no debug para n√£o causar loop
      }
    }

    function updateDebugPanel() {
      debugPanel.innerHTML = debugLogs.map(log => {
        return `<div class="log ${log.type}">[${log.time}] ${log.message}</div>`;
      }).join('');
      debugPanel.scrollTop = debugPanel.scrollHeight;
    }

    debugToggle.addEventListener('click', () => {
      debugPanel.classList.toggle('show');
      if (debugPanel.classList.contains('show')) {
        updateDebugPanel();
        debugToggle.textContent = '‚úñ';
      } else {
        debugToggle.textContent = 'üîç';
      }
    });

    // Interceptar console.log, console.error, console.warn (sem loop)
    const originalLog = console.log;
    const originalError = console.error;
    const originalWarn = console.warn;
    let isLogging = false; // Flag para evitar loop

    console.log = function(...args) {
      originalLog.apply(console, args);
      if (!isLogging) {
        isLogging = true;
        addDebugLog(args.join(' '), 'info');
        isLogging = false;
      }
    };

    console.error = function(...args) {
      originalError.apply(console, args);
      if (!isLogging) {
        isLogging = true;
        addDebugLog(args.join(' '), 'error');
        isLogging = false;
      }
    };

    console.warn = function(...args) {
      originalWarn.apply(console, args);
      if (!isLogging) {
        isLogging = true;
        addDebugLog(args.join(' '), 'warn');
        isLogging = false;
      }
    };

    // Debug: Verificar se fun√ß√µes est√£o dispon√≠veis
    window.addEventListener('load', () => {
      addDebugLog('üîç Verificando fun√ß√µes dispon√≠veis...', 'info');
      addDebugLog('  - startPlayer: ' + typeof startPlayer, 'info');
      addDebugLog('  - iniciar: ' + typeof iniciar, 'info');
      addDebugLog('  - entrarFullscreen: ' + typeof entrarFullscreen, 'info');
      
      // Verificar se bot√£o existe
      const btnEntrar = document.getElementById("btnEntrar");
      addDebugLog('  - btnEntrar existe: ' + !!btnEntrar, btnEntrar ? 'info' : 'error');
      
      if (!btnEntrar) {
        addDebugLog('‚ùå Bot√£o btnEntrar n√£o encontrado!', 'error');
      }
    });
    
    document.getElementById("btnEntrar").addEventListener("click", () => {
      addDebugLog('üîò Bot√£o clicado - chamando startPlayer()', 'info');
      try {
        if (typeof startPlayer === 'function') {
          addDebugLog('‚úÖ startPlayer √© uma fun√ß√£o, chamando...', 'info');
          startPlayer();
          addDebugLog('‚úÖ startPlayer() chamada com sucesso', 'info');
        } else {
          const errorMsg = '‚ùå startPlayer n√£o √© uma fun√ß√£o! Tipo: ' + typeof startPlayer;
          addDebugLog(errorMsg, 'error');
          alert('Erro: startPlayer n√£o est√° dispon√≠vel. Tipo: ' + typeof startPlayer + '\n\nVeja o painel de debug (bot√£o üîç)');
        }
      } catch (error) {
        const errorMsg = '‚ùå Erro ao chamar startPlayer: ' + error.message;
        addDebugLog(errorMsg, 'error');
        addDebugLog('Stack: ' + error.stack, 'error');
        alert('Erro ao iniciar: ' + error.message + '\n\nVeja o painel de debug (bot√£o üîç)');
      }
    });
    
    // For√ßar fullscreen quando a p√°gina carrega se j√° estiver em modo standalone
    window.addEventListener('load', () => {
      // Verificar se h√° c√≥digo salvo (player ativo)
      const codigoSalvo = localStorage.getItem('mrit_display_codigo');
      const temCodigoSalvo = codigoSalvo && codigoSalvo.trim();
      
      // Verificar se √© PWA instalado ou APK
      const isPWA = window.matchMedia('(display-mode: standalone)').matches || 
                    window.navigator.standalone === true ||
                    document.referrer.includes('android-app://');
      
      if (temCodigoSalvo && typeof entrarFullscreen === 'function') {
        console.log("üîí C√≥digo salvo detectado - Escondendo login e FOR√áANDO fullscreen obrigat√≥rio");
        
        // Esconder elementos de login IMEDIATAMENTE (sem delay para n√£o aparecer brevemente)
        const inputDiv = document.getElementById("codigoInput");
        const rodape = document.getElementById("rodape");
        const logo = document.getElementById("logo");
        if (inputDiv) {
          inputDiv.style.display = "none";
          inputDiv.style.opacity = "0";
          inputDiv.style.visibility = "hidden";
        }
        if (rodape) {
          rodape.style.display = "none";
          rodape.style.opacity = "0";
          rodape.style.visibility = "hidden";
        }
        if (logo) {
          logo.style.display = "none";
          logo.style.opacity = "0";
          logo.style.visibility = "hidden";
        }
        
        // Tentar fullscreen m√∫ltiplas vezes ao carregar
        setTimeout(() => {
          entrarFullscreen();
        }, 100);
        setTimeout(() => {
          entrarFullscreen();
        }, 300);
        setTimeout(() => {
          entrarFullscreen();
        }, 600);
        setTimeout(() => {
          entrarFullscreen();
        }, 1000);
        setTimeout(() => {
          entrarFullscreen();
        }, 2000);
        setTimeout(() => {
          entrarFullscreen();
        }, 3500);
        setTimeout(() => {
          entrarFullscreen();
        }, 5000);
        setTimeout(() => {
          entrarFullscreen();
        }, 7000);
      } else if (isPWA && typeof entrarFullscreen === 'function') {
        // Mesmo sem c√≥digo, tentar se for PWA
        setTimeout(() => entrarFullscreen(), 500);
      }
    });
    
    // Fun√ß√£o para verificar se o player est√° ativo (n√£o est√° na tela de login)
    function isPlayerAtivo() {
      const codigoInput = document.getElementById("codigoInput");
      const video = document.getElementById("videoPlayer");
      const img = document.getElementById("imgPlayer");
      
      // Se o campo de c√≥digo est√° vis√≠vel, o player N√ÉO est√° ativo
      if (codigoInput && codigoInput.style.display !== 'none' && !codigoInput.classList.contains('fade-out')) {
        return false;
      }
      
      // Se v√≠deo ou imagem est√£o vis√≠veis, o player est√° ativo
      if (video && video.style.display !== 'none') {
        return true;
      }
      if (img && img.style.display !== 'none') {
        return true;
      }
      
      return false;
    }
    
    // Fun√ß√µes removidas: simularCliqueNaTela e forcarFocoNoPlayer
    // Essas fun√ß√µes foram removidas pois n√£o s√£o mais necess√°rias
    
    // Fun√ß√£o auxiliar para verificar e for√ßar fullscreen
    function verificarEForcarFullscreen(contexto = '') {
      const codigoSalvo = localStorage.getItem('mrit_display_codigo');
      const localSalvo = localStorage.getItem('mrit_local_tela');
      const temCodigoCompleto = codigoSalvo && codigoSalvo.trim() && localSalvo && localSalvo.trim();
      
      // S√≥ tentar fullscreen se tiver c√≥digo salvo E o player estiver ativo (n√£o na tela de login)
      if (temCodigoCompleto && typeof entrarFullscreen === 'function' && isPlayerAtivo()) {
        // Verificar se j√° est√° em fullscreen
        const jaEstaFullscreen = document.fullscreenElement || 
                                  document.webkitFullscreenElement || 
                                  document.mozFullScreenElement || 
                                  document.msFullscreenElement;
        
        if (!jaEstaFullscreen) {
          console.log(`üîÑ ${contexto} - Tentando fullscreen autom√°tico...`);
          // M√∫ltiplas tentativas com delays progressivos
          setTimeout(() => {
            if (isPlayerAtivo()) {
              entrarFullscreen();
            }
          }, 100);
          setTimeout(() => {
            if (isPlayerAtivo()) {
              entrarFullscreen();
            }
          }, 300);
          setTimeout(() => {
            if (isPlayerAtivo()) {
              entrarFullscreen();
            }
          }, 600);
          setTimeout(() => {
            if (isPlayerAtivo()) {
              entrarFullscreen();
            }
          }, 1000);
          setTimeout(() => {
            if (isPlayerAtivo()) {
              entrarFullscreen();
            }
          }, 1500);
          setTimeout(() => {
            if (isPlayerAtivo()) {
              entrarFullscreen();
            }
          }, 2500);
          setTimeout(() => {
            if (isPlayerAtivo()) {
              entrarFullscreen();
            }
          }, 4000);
          setTimeout(() => {
            if (isPlayerAtivo()) {
              entrarFullscreen();
            }
          }, 6000);
        }
      }
    }
    
    // Tentar fullscreen quando a p√°gina ganha foco (ao reabrir o app)
    window.addEventListener('focus', () => {
      verificarEForcarFullscreen('App ganhou foco');
    });
    
    // Tentar fullscreen quando a p√°gina fica vis√≠vel (ao voltar do background)
    document.addEventListener('visibilitychange', () => {
      if (!document.hidden) {
        verificarEForcarFullscreen('P√°gina ficou vis√≠vel');
      }
    });
    
    // Tentar fullscreen quando a p√°gina √© mostrada (pageshow - ao voltar do cache)
    window.addEventListener('pageshow', (event) => {
      // Tentar sempre, n√£o s√≥ se veio do cache
      verificarEForcarFullscreen('P√°gina mostrada');
    });
    
    // Tentar fullscreen quando a janela √© redimensionada (pode indicar volta do fullscreen)
    window.addEventListener('resize', () => {
      // Debounce para n√£o executar muitas vezes
      clearTimeout(window.resizeTimeout);
      window.resizeTimeout = setTimeout(() => {
        verificarEForcarFullscreen('Janela redimensionada');
      }, 500);
    });
    
    // Tentar fullscreen quando o mouse/touch retorna (indica intera√ß√£o do usu√°rio)
    document.addEventListener('mouseenter', () => {
      verificarEForcarFullscreen('Mouse entrou na p√°gina');
    }, { once: true });
    
    // Para mobile: tentar quando toca na tela
    document.addEventListener('touchstart', () => {
      verificarEForcarFullscreen('Touch detectado');
    }, { once: true, passive: true });
    
    // Monitorar mudan√ßas no fullscreen e tentar reativar se sair
    document.addEventListener('fullscreenchange', () => {
      if (!document.fullscreenElement) {
        setTimeout(() => verificarEForcarFullscreen('Fullscreen foi desativado'), 500);
      }
    });
    
    document.addEventListener('webkitfullscreenchange', () => {
      if (!document.webkitFullscreenElement) {
        setTimeout(() => verificarEForcarFullscreen('Fullscreen WebKit foi desativado'), 500);
      }
    });
  </script>
</body>
</html>
